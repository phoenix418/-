using System.Threading;

namespace _15_11_25
{
    internal class Program
    {
        static void Main()
        {
            Chest();
            TradeExample();
            DemoDeadlock();
            DemoSolution();
        }

      

        
        #region === –ü—Ä–æ—Å—Ç–æ–µ: "–°—É–Ω–¥—É–∫ —Å –∑–æ–ª–æ—Ç–æ–º" ===
        private static int Gold = 100;
        private static object lockObject = new object();

        private static void Chest()
        {
            Thread[] tr = new Thread[3];

            for (int i = 0; i < tr.Length; i++)
            {
                tr[i] = new Thread(() =>
                {
                    for (int j = 0; j < 10; j++)
                    {
                        GoldGet();
                    }
                });
                tr[i].Name = $"–ì–µ—Ä–æ–π {i + 1}";
                tr[i].Start();
            }
            foreach (Thread t in tr)
            {
                t.Join();
            }
            Console.WriteLine($"–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–æ–ª–æ—Ç–∞: {Gold}");
        }

        private static void GoldGet()
        {
            lock (lockObject)
            {
                if (Gold >= 10)
                {
                    Thread.Sleep(10);
                    Gold -= 10;
                    Console.WriteLine($"{Thread.CurrentThread.Name} –∑–∞–±—Ä–∞–ª 10 –∑–æ–ª–æ—Ç–∞. –û—Å—Ç–∞–ª–æ—Å—å: {Gold}");
                }
                else
                {
                    Console.WriteLine($"{Thread.CurrentThread.Name} –Ω–µ –º–æ–∂–µ—Ç –∑–∞–±—Ä–∞—Ç—å –∑–æ–ª–æ—Ç–æ. –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤: {Gold}");
                }
            }
        }
        #endregion
        #region ===="–¢–æ—Ä–≥–æ–≤–ª—è –≤ —Ç–∞–≤–µ—Ä–Ω–µ"====

        private static void TradeExample()
        {
            Trader trader1 = new Trader(100);
            Trader trader2 = new Trader(50);
            Console.WriteLine($"–î–æ —Å–¥–µ–ª–∫–∏: –¢–æ—Ä–≥–æ–≤–µ—Ü1 - {trader1.Gold}, –¢–æ—Ä–≥–æ–≤–µ—Ü2 - {trader2.Gold}");
            Tavern.MakeDeal(trader1, trader2, 30);
            Tavern.MakeDeal(trader2, trader1, 10);
            Console.WriteLine($"–ü–æ—Å–ª–µ —Å–¥–µ–ª–∫–∏: –¢–æ—Ä–≥–æ–≤–µ—Ü1 - {trader1.Gold}, –¢–æ—Ä–≥–æ–≤–µ—Ü2 - {trader2.Gold}");


        }

        private class Trader
        {
            public int Gold { get; set; }
            private readonly object lockObject = new object();

            public Trader(int gold)
            {
                Gold = gold;
            }

            public object GetLock()
            {
                return lockObject;
            }
        }


        private class Tavern
        {
            private static readonly int TimeoutMs = 1000;

            public static void MakeDeal(Trader a, Trader b, int amount)
            {

                object first = a.GetLock();
                object second = b.GetLock();
                bool firstLockTaken = false;
                bool secondLockTaken = false;
                try
                {
                    Monitor.TryEnter(first, TimeoutMs, ref firstLockTaken);  
                    if (a.Gold < amount)
                    {
                        throw new InvalidOperationException($"–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞: —Ç—Ä–µ–±—É–µ—Ç—Å—è {amount}, –µ—Å—Ç—å {a.Gold}");
                    }
                    a.Gold -= amount;
                    b.Gold += amount;
                    Console.WriteLine($"–°–¥–µ–ª–∫–∞: {amount} –∑–æ–ª–æ—Ç–∞ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω–æ. –¢–µ–ø–µ—Ä—å —É A: {a.Gold}, —É B: {b.Gold}");
                }
                finally
                {
                    if (firstLockTaken)
                    {
                        Monitor.Exit(first);
                    }
                    if (secondLockTaken)
                    {
                        Monitor.Exit(second);
                    }
                }
            }    
        }
        #endregion
        #region === –°—Å–æ—Ä–∞ –¥–≤—É—Ö –≥–Ω–æ–º–æ–≤  ===
        static object anvil = new object();
        static object forge = new object();
        private static void DemoDeadlock()
        {
            Thread dwarfBlacksmith = new Thread(() =>
            {
                Console.WriteLine("–ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é anvil...");
                lock (anvil)
                {
                    Console.WriteLine("–ó–∞—Ö–≤–∞—Ç–∏–ª anvil!");
                    Thread.Sleep(100);
                    Console.WriteLine("–ü—ã—Ç–∞—é—Å—å –∑–∞—Ö–≤–∞—Ç–∏—Ç—å forge...");
                    lock (forge)
                    {
                        Console.WriteLine("–ó–∞—Ö–≤–∞—Ç–∏–ª forge! –†–∞–±–æ—Ç–∞—é...");
                    }
                }
            });

            Thread dwarfEngineer = new Thread(() =>
            {
                Console.WriteLine("–ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é forge...");
                lock (forge)
                {
                    Console.WriteLine("–ó–∞—Ö–≤–∞—Ç–∏–ª forge!");
                    Thread.Sleep(100);

                    Console.WriteLine("–ü—ã—Ç–∞—é—Å—å –∑–∞—Ö–≤–∞—Ç–∏—Ç—å anvil...");
                    lock (anvil)
                    {
                        Console.WriteLine("–ó–∞—Ö–≤–∞—Ç–∏–ª anvil! –†–∞–±–æ—Ç–∞—é...");
                    }
                }
            });
            dwarfBlacksmith.Start();
            dwarfEngineer.Start();
            Thread.Sleep(2000);
            if (dwarfBlacksmith.IsAlive || dwarfEngineer.IsAlive)
                Console.WriteLine("üíÄ –î–ï–î–õ–û–ö! –ì–Ω–æ–º—ã –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –¥—Ä—É–≥ –¥—Ä—É–≥–∞!");
            Thread.Sleep(500);
        }

        private static void DemoSolution()
        {
            Thread dwarfBlacksmith = new Thread(() =>
            {
                Console.WriteLine("–ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é anvil...");
                lock (anvil)
                {
                    Console.WriteLine("–ó–∞—Ö–≤–∞—Ç–∏–ª anvil!");
                    Thread.Sleep(100);

                    Console.WriteLine("–ü—ã—Ç–∞—é—Å—å –∑–∞—Ö–≤–∞—Ç–∏—Ç—å forge...");
                    lock (forge)
                    {
                        Console.WriteLine("–ó–∞—Ö–≤–∞—Ç–∏–ª forge! –†–∞–±–æ—Ç–∞—é...");
                    }
                }
            });

            Thread dwarfEngineer = new Thread(() =>
            {
                Console.WriteLine("–ó–∞—Ö–≤–∞—Ç—ã–≤–∞—é anvil..."); 
                lock (anvil)
                {
                    Console.WriteLine("–ó–∞—Ö–≤–∞—Ç–∏–ª anvil!");
                    Thread.Sleep(100);
                    Console.WriteLine("–ü—ã—Ç–∞—é—Å—å –∑–∞—Ö–≤–∞—Ç–∏—Ç—å forge...");
                    lock (forge)
                    {
                        Console.WriteLine("–ó–∞—Ö–≤–∞—Ç–∏–ª forge! –†–∞–±–æ—Ç–∞—é...");
                    }
                }
            });
            dwarfBlacksmith.Start();
            dwarfEngineer.Start();
            dwarfBlacksmith.Join();
            dwarfEngineer.Join();
            Console.WriteLine("‚úÖ –û–±–∞ –≥–Ω–æ–º–∞ —É—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª–∏ —Ä–∞–±–æ—Ç—É!");
        }
    }
    #endregion
    #region 

    #endregion
}

